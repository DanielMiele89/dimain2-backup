-- =============================================-- Author:  <Rory Francis>-- Create date: <2021-05-15>-- Description: < sProc to run preselection code per camapign >-- =============================================CREATE PROCEDURE [Selections].[AZF006_PreSelection_sProc]ASBEGIN
		-- Amazon prime: 2704
		-- amazon fresh: 2541
		-- Amazon prime now: 2566
		-- Amazon prime: 2704

IF OBJECT_ID('tempdb..#InputTable') IS NOT NULL DROP TABLE #InputTable
CREATE TABLE #InputTable (ColumnA VARCHAR(100))
INSERT INTO #InputTable VALUES
('AL1'),
('AL10'),
('AL2'),
('AL3'),
('AL4'),
('AL5'),
('AL6'),
('AL7'),
('AL8'),
('AL9'),
('B1'),
('B10'),
('B11'),
('B12'),
('B13'),
('B14'),
('B15'),
('B16'),
('B17'),
('B18'),
('B19'),
('B2'),
('B20'),
('B21'),
('B23'),
('B24'),
('B25'),
('B26'),
('B27'),
('B28'),
('B29'),
('B3'),
('B30'),
('B31'),
('B32'),
('B33'),
('B34'),
('B35'),
('B36'),
('B37'),
('B38'),
('B4'),
('B40'),
('B42'),
('B43'),
('B44'),
('B45'),
('B46'),
('B47'),
('B5'),
('B6'),
('B62'),
('B63'),
('B64'),
('B65'),
('B66'),
('B67'),
('B68'),
('B69'),
('B7'),
('B70'),
('B71'),
('B72'),
('B73'),
('B74'),
('B75'),
('B76'),
('B77'),
('B78'),
('B8'),
('B9'),
('B90'),
('B91'),
('B92'),
('B93'),
('BD1'),
('BD10'),
('BD11'),
('BD12'),
('BD14'),
('BD19'),
('BD2'),
('BD3'),
('BD4'),
('BD5'),
('BD6'),
('BD7'),
('BD8'),
('BD99'),
('BL0'),
('BL1'),
('BL2'),
('BL3'),
('BL4'),
('BL5'),
('BL6'),
('BL7'),
('BL8'),
('BL9'),
('CH41'),
('CH42'),
('CH43'),
('CH44'),
('CH45'),
('CM19'),
('CR0'),
('CR2'),
('CR4'),
('CR5'),
('CR7'),
('CR8'),
('CR9'),
('CV1'),
('CV2'),
('CV3'),
('CV4'),
('CV5'),
('CV6'),
('CV7'),
('DA14'),
('DA15'),
('DA16'),
('DA17'),
('DA18'),
('DA5'),
('DA6'),
('DA7'),
('DA8'),
('DH1'),
('DH2'),
('DH3'),
('DH4'),
('DH5'),
('DH6'),
('DH7'),
('DH9'),
('DN1'),
('DN11'),
('DN12'),
('DN2'),
('DN4'),
('DN5'),
('DY2'),
('DY4'),
('E1'),
('E10'),
('E11'),
('E12'),
('E13'),
('E14'),
('E15'),
('E16'),
('E17'),
('E18'),
('E1W'),
('E2'),
('E20'),
('E3'),
('E4'),
('E5'),
('E6'),
('E7'),
('E8'),
('E9'),
('EC1A'),
('EC1M'),
('EC1N'),
('EC1P'),
('EC1R'),
('EC1V'),
('EC1Y'),
('EC2A'),
('EC2M'),
('EC2N'),
('EC2P'),
('EC2R'),
('EC2V'),
('EC2Y'),
('EC3A'),
('EC3M'),
('EC3N'),
('EC3P'),
('EC3R'),
('EC3V'),
('EC4A'),
('EC4M'),
('EC4N'),
('EC4P'),
('EC4R'),
('EC4V'),
('EC4Y'),
('EN1'),
('EN10'),
('EN11'),
('EN2'),
('EN3'),
('EN4'),
('EN5'),
('EN6'),
('EN7'),
('EN8'),
('EN9'),
('FK4'),
('G1'),
('G11'),
('G12'),
('G13'),
('G14'),
('G15'),
('G2'),
('G20'),
('G21'),
('G22'),
('G23'),
('G3'),
('G31'),
('G32'),
('G33'),
('G34'),
('G4'),
('G40'),
('G41'),
('G42'),
('G43'),
('G44'),
('G45'),
('G46'),
('G5'),
('G51'),
('G52'),
('G53'),
('G58'),
('G60'),
('G61'),
('G62'),
('G64'),
('G65'),
('G66'),
('G67'),
('G68'),
('G69'),
('G71'),
('G72'),
('G73'),
('G74'),
('G75'),
('G76'),
('G77'),
('G78'),
('G79'),
('G81'),
('GU1'),
('GU10'),
('GU11'),
('GU12'),
('GU14'),
('GU15'),
('GU16'),
('GU17'),
('GU18'),
('GU19'),
('GU2'),
('GU20'),
('GU21'),
('GU22'),
('GU23'),
('GU24'),
('GU25'),
('GU3'),
('GU4'),
('GU46'),
('GU47'),
('GU51'),
('GU52'),
('GU7'),
('GU8'),
('GU9'),
('HA0'),
('HA1'),
('HA2'),
('HA3'),
('HA4'),
('HA5'),
('HA6'),
('HA7'),
('HA8'),
('HA9'),
('HD1'),
('HD2'),
('HD5'),
('HD6'),
('HP1'),
('HP2'),
('HP3'),
('IG1'),
('IG11'),
('IG2'),
('IG3'),
('IG4'),
('IG5'),
('KA1'),
('KA2'),
('KA3'),
('KA4'),
('KT1'),
('KT10'),
('KT12'),
('KT14'),
('KT15'),
('KT16'),
('KT17'),
('KT18'),
('KT19'),
('KT2'),
('KT20'),
('KT21'),
('KT22'),
('KT3'),
('KT4'),
('KT5'),
('KT6'),
('KT7'),
('KT8'),
('KT9'),
('L1'),
('L10'),
('L11'),
('L12'),
('L13'),
('L14'),
('L15'),
('L16'),
('L17'),
('L18'),
('L19'),
('L2'),
('L20'),
('L21'),
('L22'),
('L23'),
('L24'),
('L25'),
('L26'),
('L27'),
('L28'),
('L29'),
('L3'),
('L30'),
('L31'),
('L32'),
('L33'),
('L34'),
('L35'),
('L36'),
('L37'),
('L38'),
('L39'),
('L4'),
('L40'),
('L5'),
('L6'),
('L67'),
('L69'),
('L7'),
('L70'),
('L71'),
('L8'),
('L9'),
('LS1'),
('LS10'),
('LS11'),
('LS12'),
('LS13'),
('LS14'),
('LS15'),
('LS16'),
('LS17'),
('LS18'),
('LS19'),
('LS2'),
('LS25'),
('LS26'),
('LS27'),
('LS28'),
('LS3'),
('LS4'),
('LS5'),
('LS6'),
('LS7'),
('LS8'),
('LS9'),
('LS99'),
('LU1'),
('LU2'),
('LU3'),
('M1'),
('M11'),
('M12'),
('M13'),
('M14'),
('M15'),
('M16'),
('M17'),
('M18'),
('M19'),
('M2'),
('M20'),
('M21'),
('M22'),
('M23'),
('M24'),
('M25'),
('M26'),
('M27'),
('M28'),
('M29'),
('M3'),
('M30'),
('M31'),
('M32'),
('M33'),
('M34'),
('M35'),
('M38'),
('M4'),
('M40'),
('M41'),
('M43'),
('M44'),
('M45'),
('M46'),
('M5'),
('M50'),
('M6'),
('M60'),
('M7'),
('M8'),
('M9'),
('M90'),
('M99'),
('ML1'),
('ML2'),
('ML3'),
('ML4'),
('ML5'),
('ML6'),
('ML9'),
('N1'),
('N10'),
('N11'),
('N12'),
('N13'),
('N14'),
('N15'),
('N16'),
('N17'),
('N18'),
('N19'),
('N1C'),
('N2'),
('N20'),
('N21'),
('N22'),
('N3'),
('N4'),
('N5'),
('N6'),
('N7'),
('N8'),
('N9'),
('NE1'),
('NE10'),
('NE11'),
('NE12'),
('NE13'),
('NE15'),
('NE16'),
('NE17'),
('NE18'),
('NE2'),
('NE20'),
('NE21'),
('NE22'),
('NE23'),
('NE24'),
('NE25'),
('NE26'),
('NE27'),
('NE28'),
('NE29'),
('NE3'),
('NE30'),
('NE31'),
('NE32'),
('NE33'),
('NE34'),
('NE35'),
('NE36'),
('NE37'),
('NE38'),
('NE39'),
('NE4'),
('NE40'),
('NE41'),
('NE42'),
('NE43'),
('NE44'),
('NE45'),
('NE5'),
('NE6'),
('NE7'),
('NE8'),
('NE85'),
('NE9'),
('NE98'),
('NE99'),
('NW1'),
('NW10'),
('NW11'),
('NW2'),
('NW3'),
('NW4'),
('NW5'),
('NW6'),
('NW7'),
('NW8'),
('NW9'),
('OL1'),
('OL10'),
('OL11'),
('OL2'),
('OL6'),
('OL7'),
('OL8'),
('OL9'),
('PA1'),
('PA10'),
('PA11'),
('PA12'),
('PA13'),
('PA14'),
('PA2'),
('PA3'),
('PA4'),
('PA5'),
('PA6'),
('PA7'),
('PA8'),
('PA9'),
('PO1'),
('PO12'),
('PO13'),
('PO14'),
('PO15'),
('PO16'),
('PO17'),
('PO2'),
('PO3'),
('PO4'),
('PO5'),
('PO6'),
('PO7'),
('PO8'),
('PO9'),
('PR6'),
('PR7'),
('RG12'),
('RG21'),
('RG22'),
('RG24'),
('RG27'),
('RG29'),
('RG40'),
('RG41'),
('RG42'),
('RG45'),
('RM10'),
('RM13'),
('RM8'),
('RM9'),
('S1'),
('S10'),
('S11'),
('S12'),
('S13'),
('S14'),
('S2'),
('S20'),
('S21'),
('S25'),
('S26'),
('S3'),
('S35'),
('S4'),
('S5'),
('S6'),
('S60'),
('S61'),
('S62'),
('S63'),
('S64'),
('S65'),
('S66'),
('S7'),
('S70'),
('S71'),
('S72'),
('S73'),
('S74'),
('S75'),
('S8'),
('S9'),
('S96'),
('S97'),
('S98'),
('S99'),
('SE1'),
('SE10'),
('SE11'),
('SE12'),
('SE13'),
('SE14'),
('SE15'),
('SE16'),
('SE17'),
('SE18'),
('SE19'),
('SE2'),
('SE20'),
('SE21'),
('SE22'),
('SE23'),
('SE24'),
('SE25'),
('SE26'),
('SE27'),
('SE28'),
('SE3'),
('SE4'),
('SE5'),
('SE6'),
('SE7'),
('SE8'),
('SE9'),
('SG1'),
('SG12'),
('SG13'),
('SG14'),
('SG15'),
('SG16'),
('SG17'),
('SG2'),
('SG3'),
('SG4'),
('SG5'),
('SG6'),
('SG7'),
('SK1'),
('SK16'),
('SK2'),
('SK3'),
('SK4'),
('SK5'),
('SK8'),
('SL5'),
('SM1'),
('SM2'),
('SM3'),
('SM4'),
('SM5'),
('SM6'),
('SM7'),
('SO14'),
('SO15'),
('SO16'),
('SO17'),
('SO18'),
('SO19'),
('SO21'),
('SO22'),
('SO23'),
('SO30'),
('SO31'),
('SO32'),
('SO40'),
('SO50'),
('SO51'),
('SO52'),
('SO53'),
('SR1'),
('SR2'),
('SR3'),
('SR4'),
('SR5'),
('SR6'),
('SR7'),
('SR8'),
('SR9'),
('SW10'),
('SW11'),
('SW12'),
('SW13'),
('SW14'),
('SW15'),
('SW16'),
('SW17'),
('SW18'),
('SW19'),
('SW1A'),
('SW1E'),
('SW1H'),
('SW1P'),
('SW1V'),
('SW1W'),
('SW1X'),
('SW1Y'),
('SW2'),
('SW20'),
('SW3'),
('SW4'),
('SW5'),
('SW6'),
('SW7'),
('SW8'),
('SW9'),
('TW1'),
('TW10'),
('TW11'),
('TW12'),
('TW2'),
('TW20'),
('TW5'),
('TW7'),
('TW8'),
('TW9'),
('UB1'),
('UB10'),
('UB2'),
('UB3'),
('UB4'),
('UB5'),
('UB6'),
('UB8'),
('W10'),
('W11'),
('W12'),
('W13'),
('W14'),
('W1A'),
('W1B'),
('W1C'),
('W1D'),
('W1F'),
('W1G'),
('W1H'),
('W1J'),
('W1K'),
('W1S'),
('W1T'),
('W1U'),
('W1W'),
('W2'),
('W3'),
('W4'),
('W5'),
('W6'),
('W7'),
('W8'),
('W9'),
('WA1'),
('WA10'),
('WA11'),
('WA12'),
('WA13'),
('WA14'),
('WA15'),
('WA2'),
('WA3'),
('WA4'),
('WA5'),
('WA7'),
('WA8'),
('WA9'),
('WC1A'),
('WC1B'),
('WC1E'),
('WC1H'),
('WC1N'),
('WC1R'),
('WC1V'),
('WC1X'),
('WC2A'),
('WC2B'),
('WC2E'),
('WC2H'),
('WC2N'),
('WC2R'),
('WD17'),
('WD18'),
('WD19'),
('WD23'),
('WD24'),
('WD25'),
('WD3'),
('WD4'),
('WD5'),
('WD6'),
('WD7'),
('WF1'),
('WF10'),
('WF11'),
('WF12'),
('WF13'),
('WF14'),
('WF15'),
('WF16'),
('WF17'),
('WF2'),
('WF3'),
('WF5'),
('WF6'),
('WF7'),
('WF8'),
('WN1'),
('WN2'),
('WN3'),
('WN4'),
('WN5'),
('WN6'),
('WN7'),
('WN8'),
('WS1'),
('WS10'),
('WS11'),
('WS12'),
('WS14'),
('WS2'),
('WS3'),
('WS4'),
('WS5'),
('WS6'),
('WS7'),
('WS8'),
('WS9'),
('WV1'),
('WV13'),
('WV2')


-------------------------------------------------------------------------------
--ELIGIBLE CUSTOMERS
-------------------------------------------------------------------------------
		-- Amazon prime now:	2566
		-- Amazon prime:		2704
		-- amazon fresh:		2541
		-- Amazon prime:		2704

IF OBJECT_ID('tempdb..#CC_e') IS NOT NULL DROP TABLE #CC_e;
SELECT ConsumerCombinationID
INTO #CC_e
FROM warehouse.Relational.CONSUMERCOMBINATION
WHERE BRANDID IN (2704);

CREATE CLUSTERED INDEX CIX_ConsumerCombinationID ON #CC_e (ConsumerCombinationID)

DECLARE @DATE DATE = DATEADD(MONTH, -3, GETDATE())

IF OBJECT_ID('tempdb..#CT_elegible') IS NOT NULL DROP TABLE #CT_elegible;
SELECT A.CINID --,month(trandate) as tran_month,year(trandate) as tran_year,sum(amount) as spend,count(*) as transactions
INTO #CT_elegible
FROM warehouse.Relational.ConsumerTransaction_MyRewards AS A
join Warehouse.Relational.CINList cin on cin.CINID = a.CINID
JOIN Warehouse.Relational.Customer C on C.SourceUID = cin.CIN
WHERE amount >= 0
and CONSUMERCOMBINATIONiD IN (SELECT * FROM #CC_e)
AND CURRENTLYACTIVE = 1	
AND TranDate >= @DATE
and PostCodeDistrict in (select columna from #InputTable)
--and a.CINID not in (select * from Sandbox.BastienC.AMAZON_FRESH_1)
--group by A.CINID,month(trandate),year(trandate);

-------------------------------------------------------------------------------
--PRIME NOW CUSTOMERS
-------------------------------------------------------------------------------
		-- Amazon prime now:	2566
		-- Amazon prime:		2704
		-- amazon fresh:		2541
		-- Amazon prime:		2704

IF OBJECT_ID('tempdb..#CC_PN') IS NOT NULL DROP TABLE #CC_PN;
SELECT ConsumerCombinationID
INTO #CC_PN
FROM warehouse.Relational.CONSUMERCOMBINATION
WHERE BRANDID IN (2566);

CREATE CLUSTERED INDEX CIX_ConsumerCombinationID ON #CC_PN (ConsumerCombinationID)

DECLARE @DATE2 DATE = DATEADD(MONTH, -12, GETDATE())

IF OBJECT_ID('tempdb..#CT_PN') IS NOT NULL DROP TABLE #CT_PN;
SELECT A.CINID
INTO #CT_PN
FROM warehouse.Relational.ConsumerTransaction_MyRewards AS A
join Warehouse.Relational.CINList cin on cin.CINID = a.CINID
JOIN Warehouse.Relational.Customer C on C.SourceUID = cin.CIN
WHERE amount >= 0
and CONSUMERCOMBINATIONiD IN (SELECT * FROM #CC_PN)
AND CURRENTLYACTIVE = 1	
AND TranDate >= @DATE2


-------------------------------------------------------------------------------
--FINAL OUTPUT
-------------------------------------------------------------------------------
		-- Amazon prime now:	2566
		-- Amazon prime:		2704
		-- amazon fresh:		2541
		-- Amazon prime:		2704

IF OBJECT_ID('tempdb..#CC') IS NOT NULL DROP TABLE #CC;
SELECT ConsumerCombinationID
INTO #CC
FROM warehouse.Relational.CONSUMERCOMBINATION
WHERE BRANDID IN (2541);

CREATE CLUSTERED INDEX CIX_ConsumerCombinationID ON #CC (ConsumerCombinationID)

IF OBJECT_ID('tempdb..#CT') IS NOT NULL DROP TABLE #CT;
SELECT A.CINID 
INTO #CT
FROM warehouse.Relational.ConsumerTransaction_MyRewards AS A
join Warehouse.Relational.CINList cin on cin.CINID = a.CINID
JOIN Warehouse.Relational.Customer C on C.SourceUID = cin.CIN
WHERE amount >= 0
and CONSUMERCOMBINATIONiD IN (SELECT * FROM #CC)
AND CURRENTLYACTIVE = 1	



DECLARE @DATE3 DATE = DATEADD(MONTH, -1, GETDATE())

IF OBJECT_ID('tempdb..#CT_GT1') IS NOT NULL DROP TABLE #CT_GT1;
SELECT A.CINID 
INTO #CT_GT1
FROM warehouse.Relational.ConsumerTransaction_MyRewards AS A
join Warehouse.Relational.CINList cin on cin.CINID = a.CINID
JOIN Warehouse.Relational.Customer C on C.SourceUID = cin.CIN
WHERE amount >= 0
and CONSUMERCOMBINATIONiD IN (SELECT * FROM #CC)
AND CURRENTLYACTIVE = 1	
AND TranDate  >= @DATE3

IF OBJECT_ID('tempdb..#final_output') IS NOT NULL DROP TABLE #final_output;
select distinct cinid
into #final_output
from #CT_elegible
WHERE CINID IN (SELECT * FROM #CT_PN)
or CINID IN (SELECT * FROM #CT_GT1)						If Object_ID('Warehouse.Selections.AZF006_PreSelection') Is Not Null Drop Table Warehouse.Selections.AZF006_PreSelectionSelect FanIDInto Warehouse.Selections.AZF006_PreSelectionFROM Relational.Customer cuWHERE EXISTS (	SELECT 1				FROM [Relational].[CINList] cl				INNER JOIN #final_output fo					ON cl.CINID = fo.CINID				WHERE cu.SourceUID = cl.CIN)END