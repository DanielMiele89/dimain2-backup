-- =============================================-- Author:  <Rory Francis>-- Create date: <2020-02-21>-- Description: < sProc to run preselection code per camapign >-- =============================================CREATE PROCEDURE [Selections].[MOR051_PreSelection_sProc]ASBEGINIf Object_ID('tempdb..#QualifyingTransaction') Is Not Null Drop Table #QualifyingTransactionSELECT DISTINCT	   pt.FanID	 , cu.CompositeIDINTO #QualifyingTransactionFROM [Relational].[PartnerTrans] ptINNER JOIN [Relational].[Customer] cu	ON pt.FanID = cu.FanIDWHERE IronOfferID IN (18436,18437,18438,18439,18440,18441)CREATE CLUSTERED INDEX CIX_FanID ON #QualifyingTransaction (FanID)CREATE NONCLUSTERED INDEX IX_CompositeID ON #QualifyingTransaction (CompositeID)If Object_ID('tempdb..#TransactionQuotaMet') Is Not Null Drop Table #TransactionQuotaMetSELECT FanID	 , COUNT(*) AS TransactionsINTO #TransactionQuotaMetFROM [Relational].[PartnerTrans] ptWHERE IronOfferID IN (19591,19592)GROUP BY FanIDHAVING COUNT(*) > 2CREATE CLUSTERED INDEX CIX_FanID ON #TransactionQuotaMet (FanID)If Object_ID('tempdb..#IOM') Is Not Null Drop Table #IOMSELECT CompositeID	 , MIN(StartDate) AS StartDateINTO #IOMFROM [Relational].[IronOfferMember] iomWHERE iom.IronOfferID IN (19591,19592)GROUP BY CompositeIDIf Object_ID('tempdb..#IOM_PT') Is Not Null Drop Table #IOM_PTSELECT qt.FanID	 , StartDate	 , ROW_NUMBER() OVER (ORDER BY COALESCE(StartDate, '9999-01-01'), NEWID()) AS CustomerRankINTO #IOM_PTFROM #QualifyingTransaction qtLEFT JOIN #IOM iom	ON qt.CompositeID = iom.CompositeIDWHERE NOT EXISTS (	SELECT 1					FROM #TransactionQuotaMet tqm					WHERE qt.FanID = tqm.FanID)If Object_ID('Warehouse.Selections.MOR051_PreSelection') Is Not Null Drop Table Warehouse.Selections.MOR051_PreSelectionSelect DISTINCT	   FanIDINTO Warehouse.Selections.MOR051_PreSelectionFROM #IOM_PTWHERE CustomerRank <= 15000END